<!DOCTYPE html>
<html>
<head>
    <title>FeatureMap</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("FeatureMap",{extend:"Rally.app.TimeboxScopedApp",componentCls:"app",scopeType:"release",comboboxConfig:{fieldLabel:"Select a PI:",labelWidth:100,width:300},requires:["Rally.ui.cardboard.plugin.FixedHeader"],onScopeChange:function(){this._getLowPI()},_getLowPI:function(){this.piType?this._DrawBoard():Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,remoteFilter:!1,model:"TypeDefinition",sorters:[{property:"Ordinal",direction:"Desc"}],filters:[{property:"Parent.Name",operator:"=",value:"Portfolio Item"},{property:"Creatable",operator:"=",value:"true"}],listeners:{load:function(store,recs){piTypes={},Ext.Array.each(recs,function(type){piTypes[type.get("Ordinal")+""]=type.get("TypePath")}),this.piType=piTypes[0],this._DrawBoard()},scope:this}})},_DrawBoard:function(){app=this;var hdrFontSize=app.getSetting("hdrFontSize"),smSize=+hdrFontSize-4,smFontSize=smSize.toString();Ext.create("Rally.data.wsapi.Store",{model:this.piType,fetch:["Name","ObjectID","Project","FormattedID","Rank","Parent","Release","DisplayColor","PreliminaryEstimateValue","PercentDoneByStoryPlanEstimate","LeafStoryPlanEstimateTotal"],limit:1/0,filters:[this.getContext().getTimeboxScope().getQueryFilter()],sorters:[{property:app.getSetting("SortCol"),direction:"ASC"}],autoLoad:!0,listeners:{load:function(myStore,myData,mySuccess){var columns=[{record:null,value:null,columnHeaderConfig:{headerData:{PIhdr:'<p style="color: Red; font-size: '+hdrFontSize+'px"; font-weight: bolder>No Parent</>'}}}];_.each(myData,function(record){var fpiColor=app.getSetting("useFColor")?record.get("DisplayColor"):"Black",ppiColor=null!==record.get("Parent")?app.getSetting("usePColor")?record.get("Parent").DisplayColor:"Black":"Grey",hdrStr=(app.getSetting("showParent")?'<p style="color:'+ppiColor+"; font-size: "+hdrFontSize+'px; font-weight: bolder">'+(null!==record.get("Parent")?'<a href="https://rally1.rallydev.com/#/detail'+record.get("Parent")._ref+'" target = "_top">'+record.get("Parent").FormattedID+"</a> - "+record.get("Parent").Name:" (No Parent)")+'<hr size="2" />':"")+'<p style="color: '+fpiColor+"; font-size: "+hdrFontSize+'px; font-weight: bolder"><a href="https://rally1.rallydev.com/#/detail'+record.get("_ref")+'" target = "_top">'+record.get("FormattedID")+"</a> - "+record.get("_refObjectName")+(app.getSetting("showCounts")?'<p style="color: grey; font-weight: normal; font-size: '+smFontSize+'px">('+(null!==record.get("PreliminaryEstimateValue")?record.get("PreliminaryEstimateValue"):"0")+" FP / "+(null!==record.get("LeafStoryPlanEstimateTotal")?record.get("LeafStoryPlanEstimateTotal"):"0")+" SP)":"")+"</>";columns.push({record:record,value:record.getRef().getRelativeUri(),columnHeaderConfig:{headerData:{PIhdr:hdrStr}}})}),app.getSetting("showAddnew")&&app._addNewButton(),app._addBoard(columns)},scope:this}})},_addNewButton:function(){app.addButton&&app.addButton.destroy(),addNewConfig={xtype:"rallyaddnew",recordTypes:["User Story"],ignoredRequiredFields:["Name","ScheduleState","Project","Owner"],listeners:{create:function(addNew,record){}},showAddWithDetails:!0},app.addButton=this.add(addNewConfig)},_addBoard:function(columns){this.down("#myBoard")&&this.remove("myBoard"),boardConfig={xtype:"rallycardboard",types:["User Story"],storeConfig:{filters:app.getQueryFilter()},attribute:this.piType.split("/")[1],itemId:"myBoard",context:this.getContext(),enableRanking:!0,cardConfig:{fields:app.getSetting("cardFields").split(","),editable:!0,showIconsAndHighlightBorder:!0,showReadyIcon:!0,showBlockedIcon:!0,showColorIcon:!0,showPlusIcon:!0,showGearIcon:!0},plugins:[{ptype:"rallyfixedheadercardboard"}],columnConfig:{columnHeaderConfig:{headerTpl:"{PIhdr}"},listeners:{scope:this,beforecarddroppedsave:function(column,card){var rec=card.getRecord();rec.set("PortfolioItem",column.getValue())}}},rowConfig:{field:app.getSetting("Swimlane"),enableCrossRowDragging:!0,sortDirection:"ASC"},columns:columns},app.board=this.add(boardConfig)},_showMask:function(msg){this.getEl()&&(this.getEl().unmask(),this.getEl().mask(msg))},_hideMask:function(){this.getEl().unmask()},getSettingsFields:function(){var values=[{xtype:"rallyfieldpicker",name:"cardFieldPicker",fieldLabel:"Card Fields:",alwaysExpanded:!1,autoExpand:!0,alwaysSelectedValues:["Name","Owner"],modelTypes:["User Story"],boxLabelAlign:"after",margin:"0 0 15 400",labelStyle:"width:200px;",handlesEvents:{myspecialevent2:function(field,model){this.setField(field.raw.fieldDefinition)}},listeners:{select:function(field_picker,value,values){this.fireEvent("field_selected",values)},deselect:function(field_picker,value,values){this.fireEvent("field_selected",values)}},bubbleEvents:["field_selected"]},{name:"cardFields",hidden:!0,xtype:"rallytextfield",handlesEvents:{field_selected:function(fields){var fieldStr="";_.each(fields,function(field){fieldStr+=field.get("name")+","}),this.setValue(fieldStr.slice(0,-1))}}},{xtype:"rallycheckboxfield",margin:"0 0 15 0",labelWidth:200,fieldLabel:"Show Add New Story:",name:"showAddnew"},{xtype:"label",forId:"myFieldId3",text:"Column Settings:",margin:"0 0 0 0"},{xtype:"rallytextfield",name:"hdrFontSize",fieldLabel:"Column Header Font Size:",maxLength:2,labelWidth:200,width:250,margin:"0 0 0 20"},{xtype:"rallycheckboxfield",margin:"0 0 0 20",labelWidth:200,fieldLabel:"Show Parent:",name:"showParent"},{xtype:"rallycheckboxfield",labelWidth:200,margin:"0 0 0 20",fieldLabel:"Color for Feature Title:",name:"useFColor"},{xtype:"rallycheckboxfield",labelWidth:200,margin:"0 0 0 20",fieldLabel:"Color for Parent Title:",name:"usePColor"},{xtype:"rallycheckboxfield",margin:"0 0 5 20",labelWidth:200,fieldLabel:"Show Counts:",name:"showCounts"},{xtype:"label",forId:"myFieldId3",text:"Sort by:",margin:"0 0 0 20"},{xtype:"rallyradiofield",fieldLabel:"Parent",margin:"0 0 0 40",name:"SortCol",label:"Swimlane",inputValue:"Parent"},{xtype:"rallyradiofield",margin:"0 0 15 40",fieldLabel:"Rank",name:"SortCol",inputValue:"Rank"},{xtype:"label",forId:"myFieldId4",text:"Swimlanes:",margin:"0 0 0 0"},{xtype:"rallyradiofield",fieldLabel:"Teams",margin:"0 0 0 20",name:"Swimlane",inputValue:"Project"},{xtype:"rallyradiofield",margin:"0 0 15 20",fieldLabel:"None",name:"Swimlane",inputValue:""},{type:"query"}];return values},config:{defaultSettings:{showAddnew:!1,cardFields:"Name,Owner",SortCol:"Rank",Swimlane:"Project",hdrFontSize:"16",showParent:!0,useFColor:!1,usePColor:!0,showCounts:!0}},getQueryFilter:function(){var queries=[];return app.getSetting("query")&&queries.push(Rally.data.QueryFilter.fromQueryString(app.getSetting("query"))),queries}});

            Rally.launchApp('FeatureMap', {
                name:"FeatureMap",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app p{margin:0}
    </style>
</head>
<body>
</body>
</html>
